<div class="template-form-container">
  <div class="template-form-header">
    <h1>{{ editMode ? 'Edit Workout Template' : 'Create Workout Template' }}</h1>
    <p>{{ editMode ? 'Modify your existing workout routine' : 'Design a custom workout routine' }}</p>
  </div>
  
  <div *ngIf="loadingData" class="loading-spinner">
    <div class="spinner-border" role="status">
      <span class="sr-only">Loading...</span>
    </div>
  </div>
  
  <div *ngIf="!loadingData" class="template-form-content">
    <form [formGroup]="templateForm" (ngSubmit)="onSubmit()">
      <div class="template-form-card">
        <h2>Template Details</h2>
        
        <div class="form-group">
          <label for="name">Template Name</label>
          <input 
            type="text" 
            formControlName="name" 
            class="form-control" 
            [ngClass]="{ 'is-invalid': f['name'].touched && f['name'].errors }" 
          />
          <div *ngIf="f['name'].touched && f['name'].errors" class="invalid-feedback">
            <div *ngIf="f['name'].errors['required']">Template name is required</div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="description">Description (Optional)</label>
          <textarea 
            formControlName="description" 
            class="form-control" 
            rows="3"
          ></textarea>
        </div>
        
        <div class="form-check">
          <input 
            type="checkbox" 
            formControlName="isPublic" 
            class="form-check-input" 
            id="isPublic"
          />
          <label class="form-check-label" for="isPublic">Make this template public</label>
          <small class="form-text text-muted">Public templates can be viewed and used by other users</small>
        </div>
      </div>
      
      <div class="template-form-card">
        <div class="exercises-header">
          <h2>Exercises</h2>
          <button type="button" class="btn btn-sm btn-outline-primary" (click)="addExercise()">
            Add Exercise
          </button>
        </div>
        
        <div *ngIf="exercisesArray.length === 0" class="no-exercises">
          <p>No exercises added yet. Click "Add Exercise" to start building your template.</p>
        </div>
        
        <div formArrayName="exercises" class="exercises-list">
          <div *ngFor="let exerciseGroup of exercisesArray.controls; let i = index" class="exercise-item">
            <div [formGroupName]="i" class="exercise-form">
              <div class="exercise-header">
                <h3>Exercise {{ i + 1 }}</h3>
                <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeExercise(i)">
                  Remove
                </button>
              </div>
              
              <div class="form-group">
                <label for="exercise-{{i}}">Exercise</label>
                <div class="exercise-select-container">
                  <input 
                    type="text" 
                    [(ngModel)]="searchTerm" 
                    [ngModelOptions]="{standalone: true}" 
                    (input)="onSearchChange()" 
                    placeholder="Search exercises..." 
                    class="form-control exercise-search"
                  />
                  <select 
                    formControlName="exercise" 
                    class="form-control" 
                    [ngClass]="{ 'is-invalid': exercisesArray.at(i).get('exercise')?.touched && exercisesArray.at(i).get('exercise')?.errors }"
                  >
                    <option value="">Select Exercise</option>
                    <option *ngFor="let exercise of filteredExercises" [value]="exercise._id">{{ exercise.name }}</option>
                  </select>
                  <div *ngIf="exercisesArray.at(i).get('exercise')?.touched && exercisesArray.at(i).get('exercise')?.errors" class="invalid-feedback">
                    <div *ngIf="exercisesArray.at(i).get('exercise')?.errors?.['required']">Exercise is required</div>
                  </div>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label for="sets-{{i}}">Sets</label>
                  <input 
                    type="number" 
                    formControlName="sets" 
                    class="form-control" 
                    [ngClass]="{ 'is-invalid': exercisesArray.at(i).get('sets')?.touched && exercisesArray.at(i).get('sets')?.errors }" 
                  />
                  <div *ngIf="exercisesArray.at(i).get('sets')?.touched && exercisesArray.at(i).get('sets')?.errors" class="invalid-feedback">
                    <div *ngIf="exercisesArray.at(i).get('sets')?.errors?.['required']">Sets is required</div>
                    <div *ngIf="exercisesArray.at(i).get('sets')?.errors?.['min']">Sets must be at least 1</div>
                  </div>
                </div>
                
                <div class="form-group col-md-4">
                  <label for="reps-{{i}}">Reps</label>
                  <input 
                    type="number" 
                    formControlName="reps" 
                    class="form-control" 
                    [ngClass]="{ 'is-invalid': exercisesArray.at(i).get('reps')?.touched && exercisesArray.at(i).get('reps')?.errors }" 
                  />
                  <div *ngIf="exercisesArray.at(i).get('reps')?.touched && exercisesArray.at(i).get('reps')?.errors" class="invalid-feedback">
                    <div *ngIf="exercisesArray.at(i).get('reps')?.errors?.['required']">Reps is required</div>
                    <div *ngIf="exercisesArray.at(i).get('reps')?.errors?.['min']">Reps must be at least 1</div>
                  </div>
                </div>
                
                <div class="form-group col-md-4">
                  <label for="restTime-{{i}}">Rest Time (seconds)</label>
                  <input 
                    type="number" 
                    formControlName="restTime" 
                    class="form-control" 
                    [ngClass]="{ 'is-invalid': exercisesArray.at(i).get('restTime')?.touched && exercisesArray.at(i).get('restTime')?.errors }" 
                  />
                  <div *ngIf="exercisesArray.at(i).get('restTime')?.touched && exercisesArray.at(i).get('restTime')?.errors" class="invalid-feedback">
                    <div *ngIf="exercisesArray.at(i).get('restTime')?.errors?.['required']">Rest time is required</div>
                    <div *ngIf="exercisesArray.at(i).get('restTime')?.errors?.['min']">Rest time must be at least 0</div>
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="notes-{{i}}">Notes (Optional)</label>
                <textarea 
                  formControlName="notes" 
                  class="form-control" 
                  rows="2"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-outline-secondary" (click)="cancel()">
          Cancel
        </button>
        <button type="submit" [disabled]="templateForm.invalid || loading" class="btn btn-primary">
          <span *ngIf="loading" class="spinner-border spinner-border-sm mr-1"></span>
          {{ editMode ? 'Update Template' : 'Create Template' }}
        </button>
      </div>
    </form>
    
    <div *ngIf="submitSuccess" class="alert alert-success mt-3">
      Template {{ editMode ? 'updated' : 'created' }} successfully!
    </div>
    
    <div *ngIf="error" class="alert alert-danger mt-3">
      {{ error }}
    </div>
  </div>
</div>
